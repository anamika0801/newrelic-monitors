- name: ðŸš€ Execute New Relic SLO Mutation
Â  Â  Â  Â  env:
Â  Â  Â  Â    # ... (other environment variables remain the same)
Â  Â  Â  Â  Â  ACTION: ${{ steps.setup.outputs.slo_action }}
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  MUTATION_PAYLOAD=""
Â  Â  Â  Â  Â  MUTATION_RESULT_PATH=""
          # ... (delete path remains the same)

Â  Â  Â  Â  Â  elif [ -z "$GUID" ]; then
Â  Â  Â  Â  Â  Â  Â  # --- CREATE PATH ---
Â  Â  Â  Â  Â  Â  Â  echo "Preparing CREATE mutation for SLO: $SLO_NAME"
Â  Â  Â  Â  Â  Â  Â  MUTATION_RESULT_PATH=".data.serviceLevelCreate"
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  # Construct the SLI/Indicator Input object (NRQL type)
Â  Â  Â  Â  Â  Â  Â  INDICATOR_INPUT=$(jq -n \
Â  Â  Â  Â  Â  Â  Â  Â  Â  --arg name "$SLO_NAME" \
Â  Â  Â  Â  Â  Â  Â  Â  Â  --arg expression "$NRQL_EXPRESSION" \
Â  Â  Â  Â  Â  Â  Â  Â  Â  --arg entityGuid "$ENTITY_GUID" \
Â  Â  Â  Â  Â  Â  Â  Â  Â  '{ name: $name, type: "NRQL", nrql: { query: $expression, entityGuid: $entityGuid } }')

              # Construct the Objectives Input object (Assuming you pass DAY and count 7 in your slo_details.json)
              # NOTE: Your original YAML didn't expose 'unit' and 'count' variables, 
              # but I must add them to match the correct mutation's {rolling: {unit: DAY, count: 7}} structure.
              # I'll use '$TIME_WINDOW' as the unit and set count to 7 as a placeholder.
              # *** YOU MAY NEED TO ADJUST YOUR slo_details.json and setup step to pass 'unit' and 'count' ***
              # For this fix, I'll hardcode the objectives structure based on your example:
Â  Â  Â  Â  Â  Â  Â  OBJECTIVES_INPUT=$(jq -n \
Â  Â  Â  Â  Â  Â  Â  Â  Â  --arg name "$SLO_NAME" \
Â  Â  Â  Â  Â  Â  Â  Â  Â  --arg target "$TARGET" \
                  --arg timeWindow "$TIME_WINDOW" \
Â  Â  Â  Â  Â  Â  Â  Â  Â  '[{ name: $name, target: ($target | tonumber), timeWindow: { rolling: { unit: $timeWindow, count: 7 } } }]')

Â  Â  Â  Â  Â  Â  Â  MUTATION_PAYLOAD=$(jq -n \
Â  Â  Â  Â  Â  Â  Â  Â  --arg entityGuid "$ENTITY_GUID" \
Â  Â  Â  Â  Â  Â  Â  Â  --argjson indicator "$INDICATOR_INPUT" \
Â  Â  Â  Â  Â  Â  Â  Â  --argjson objectives "$OBJECTIVES_INPUT" \
Â  Â  Â  Â  Â  Â  Â  Â  '{
Â  Â  Â  Â  Â  Â  Â  Â  Â  query: "mutation CreateServiceLevel($entityGuid: EntityGuid!, $indicator: ServiceLevelIndicatorCreateInput!, $objectives: [ServiceLevelObjectiveInput!]!) { serviceLevelCreate(entityGuid: $entityGuid, indicator: $indicator, objectives: $objectives) { description guid createdAt createdBy { name } } }",
Â  Â  Â  Â  Â  Â  Â  Â  Â  variables: { entityGuid: $entityGuid, indicator: $indicator, objectives: $objectives }
Â  Â  Â  Â  Â  Â  Â  Â  }')
              # Note: This query returns 'description', 'guid', etc., to match the desired output fields of your initial correct mutation example.

Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  Â  # --- UPDATE PATH ---
Â  Â  Â  Â  Â  Â  Â  echo "Preparing UPDATE mutation for SLO: $SLO_NAME (GUID: $GUID)"
Â  Â  Â  Â  Â  Â  Â  MUTATION_RESULT_PATH=".data.serviceLevelUpdate"

              # The UPDATE mutation also needs to be changed to match the new structure
Â  Â  Â  Â  Â  Â  Â  INDICATOR_INPUT=$(jq -n \
Â  Â  Â  Â  Â  Â  Â  Â  Â  --arg name "$SLO_NAME" \
Â  Â  Â  Â  Â  Â  Â  Â  Â  --arg expression "$NRQL_EXPRESSION" \
Â  Â  Â  Â  Â  Â  Â  Â  Â  --arg entityGuid "$ENTITY_GUID" \
Â  Â  Â  Â  Â  Â  Â  Â  Â  '{ name: $name, type: "NRQL", nrql: { query: $expression, entityGuid: $ENTITY_GUID } }')

Â  Â  Â  Â  Â  Â  Â  OBJECTIVES_INPUT=$(jq -n \
Â  Â  Â  Â  Â  Â  Â  Â  Â  --arg name "$SLO_NAME" \
Â  Â  Â  Â  Â  Â  Â  Â  Â  --arg target "$TARGET" \
                  --arg timeWindow "$TIME_WINDOW" \
Â  Â  Â  Â  Â  Â  Â  Â  Â  '[{ name: $name, target: ($target | tonumber), timeWindow: { rolling: { unit: $timeWindow, count: 7 } } }]')

Â  Â  Â  Â  Â  Â  Â  MUTATION_PAYLOAD=$(jq -n \
Â  Â  Â  Â  Â  Â  Â  Â  --arg guid "$GUID" \
Â  Â  Â  Â  Â  Â  Â  Â  --argjson indicator "$INDICATOR_INPUT" \
Â  Â  Â  Â  Â  Â  Â  Â  --argjson objectives "$OBJECTIVES_INPUT" \
Â  Â  Â  Â  Â  Â  Â  Â  '{
Â  Â  Â  Â  Â  Â  Â  Â  Â  query: "mutation UpdateServiceLevel($guid: EntityGuid!, $indicator: ServiceLevelIndicatorUpdateInput!, $objectives: [ServiceLevelObjectiveInput!]!) { serviceLevelUpdate(guid: $guid, indicator: $indicator, objectives: $objectives) { description guid } }",
Â  Â  Â  Â  Â  Â  Â  Â  Â  variables: { guid: $guid, indicator: $indicator, objectives: $objectives }
Â  Â  Â  Â  Â  Â  Â  Â  }')
Â  Â  Â  Â  Â  fi
# ... (rest of the script)
